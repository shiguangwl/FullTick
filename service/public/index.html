<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŒ‡æ•°æ•°æ®ç›‘æ§é¢æ¿</title>
    <style>
      /* ========== CSSå˜é‡ ========== */
      :root {
        --color-primary: #667eea;
        --color-primary-dark: #764ba2;
        --color-bg-high: #fee2e2;
        --color-bg-low: #dcfce7;
        --color-bg-light: #f8fafc;
        --color-bg-lighter: #fafbfc;
        --color-text-primary: #1e293b;
        --color-text-secondary: #475569;
        --color-text-muted: #64748b;
        --color-border: #e2e8f0;
        --color-border-light: #f1f5f9;
        --color-accent: #3b82f6;
        --color-error: #dc2626;
        --gradient-primary: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      }

      /* ========== åŸºç¡€æ ·å¼ ========== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: var(--gradient-primary);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      /* ========== å¤´éƒ¨æ ·å¼ ========== */
      .header {
        background: var(--gradient-primary);
        color: white;
        padding: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 600;
      }

      .header-info {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .info-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        backdrop-filter: blur(10px);
      }

      /* ========== ç»Ÿè®¡å¡ç‰‡ ========== */
      .stats-grid {
        display: flex;
        flex-wrap: nowrap;
        gap: 15px;
        padding: 20px;
        background: var(--color-bg-light);
        border-bottom: 1px solid var(--color-border);
        overflow-x: auto;
      }

      .stat-card {
        flex: 1;
        min-width: 0;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      /* ç»Ÿè®¡å¡ç‰‡é«˜äº®åŠ¨ç”» */
      .stat-card.highlight-stat {
        animation: highlightStat 1.5s ease-in-out;
      }

      @keyframes highlightStat {
        0% {
          background-color: #dbeafe;
          transform: scale(1.05);
        }
        50% {
          background-color: #bfdbfe;
        }
        100% {
          background-color: white;
          transform: scale(1);
        }
      }

      .stat-label {
        font-size: 12px;
        color: var(--color-text-muted);
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      /* ========== è¡¨æ ¼æ ·å¼ ========== */
      .table-container {
        overflow-x: auto;
        padding: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      thead {
        background: var(--color-bg-light);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      th {
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        color: var(--color-text-secondary);
        border-bottom: 2px solid var(--color-border);
        white-space: nowrap;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
      }

      th:hover {
        background-color: var(--color-border);
      }

      th.sortable::after {
        content: ' â‡…';
        opacity: 0.3;
        font-size: 10px;
      }

      th.sort-asc::after {
        content: ' â–²';
        opacity: 1;
        color: var(--color-accent);
      }

      th.sort-desc::after {
        content: ' â–¼';
        opacity: 1;
        color: var(--color-accent);
      }

      td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid var(--color-border-light);
        transition: background-color 0.3s;
      }

      tbody tr:hover {
        background-color: var(--color-bg-light);
      }

      tbody tr:nth-child(even) {
        background-color: var(--color-bg-lighter);
      }

      /* ========== çŠ¶æ€æ ·å¼(åˆå¹¶é‡å¤æ ·å¼) ========== */
      .signal-high,
      .boolean-true,
      .percent-high,
      .score-high {
        background-color: var(--color-bg-high) !important;
        color: #000;
        font-weight: 600;
      }

      .signal-low,
      .boolean-false,
      .percent-low,
      .score-low {
        background-color: var(--color-bg-low) !important;
        color: #000;
        font-weight: 600;
      }

      .percent-value {
        font-weight: 600;
      }

      /* ========== æ¶ˆæ¯çŠ¶æ€ ========== */
      .loading,
      .error,
      .no-data {
        text-align: center;
        padding: 40px;
      }

      .loading,
      .no-data {
        color: var(--color-text-muted);
      }

      .error {
        color: var(--color-error);
      }

      .no-data {
        padding: 60px;
        font-size: 16px;
      }

      /* ========== åŠ¨ç”»æ•ˆæœ ========== */
      .highlight-new {
        animation: highlightNew 2s ease-in-out;
      }

      .highlight-updated {
        animation: highlightUpdated 1.2s ease-in-out;
      }

      @keyframes highlightNew {
        0% {
          background-color: #86efac;
          transform: scale(1.02);
          box-shadow: 0 0 20px rgba(134, 239, 172, 0.6);
        }
        50% {
          background-color: #bbf7d0;
        }
        100% {
          background-color: transparent;
          transform: scale(1);
          box-shadow: none;
        }
      }

      @keyframes highlightUpdated {
        0% {
          background-color: #93c5fd;
          transform: scale(1.01);
        }
        50% {
          background-color: #bfdbfe;
        }
        100% {
          background-color: transparent;
          transform: scale(1);
        }
      }

      /* ========== å·¥å…·ç±» ========== */
      .code-cell {
        font-weight: 600;
        color: var(--color-accent);
      }

      .time-cell {
        font-size: 11px;
        color: var(--color-text-muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“Š æŒ‡æ•°æ•°æ®ç›‘æ§é¢æ¿</h1>
        <div class="header-info">
          <div class="info-badge">
            <span class="network-status online" id="networkStatus"></span>
            <span id="lastUpdate">åŠ è½½ä¸­...</span>
          </div>
          <div class="info-badge">æ•°æ®æ¡æ•°: <span id="dataCount">0</span></div>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>

      <div class="table-container">
        <div id="loadingDiv" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="errorDiv" class="error" style="display: none"></div>
        <table id="dataTable" style="display: none">
          <thead>
            <tr>
              <th class="sortable" data-column="updateTime" data-type="string">æ›´æ–°æ—¶é—´</th>
              <th class="sortable" data-column="etfCode" data-type="string">ä»£ç </th>
              <th class="sortable" data-column="etfName" data-type="string">åç§°</th>
              <th class="sortable" data-column="totalScore" data-type="number">æ€»åˆ†</th>
              <th class="sortable" data-column="m5Signal" data-type="string">M5ä¿¡å·</th>
              <th class="sortable" data-column="greaterThanM5Price" data-type="boolean">5æ—¥</th>
              <th class="sortable" data-column="greaterThanM10Price" data-type="boolean">10æ—¥</th>
              <th class="sortable" data-column="greaterThanM20Price" data-type="boolean">20æ—¥</th>
              <th class="sortable" data-column="m0Percent" data-type="percent">M0å æ¯”</th>
              <th class="sortable" data-column="m5Percent" data-type="percent">M5å æ¯”</th>
              <th class="sortable" data-column="m10Percent" data-type="percent">M10å æ¯”</th>
              <th class="sortable" data-column="m20Percent" data-type="percent">M20å æ¯”</th>
              <th class="sortable" data-column="maMeanRatio" data-type="percent">Maå‡å€¼</th>
              <th class="sortable" data-column="growthStockCount" data-type="number">å¢é•¿è‚¡æ•°</th>
              <th class="sortable" data-column="totalStockCount" data-type="number">æ€»è‚¡æ•°</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="noDataDiv" class="no-data" style="display: none">æš‚æ— æ•°æ®</div>
      </div>
    </div>

    <script>
      let previousData = [];
      let lastUpdateTime = null;
      let isFirstLoad = true;
      let networkStatus = 'online';
      let sortColumn = null;  // å½“å‰æ’åºåˆ—
      let sortDirection = 'asc';  // æ’åºæ–¹å‘: 'asc' æˆ– 'desc'

      // æ›´æ–°ç½‘ç»œçŠ¶æ€
      function updateNetworkStatus(status) {
        networkStatus = status;
        const statusElement = document.getElementById('networkStatus');
        statusElement.className = `network-status ${status}`;
      }

      // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
      function formatPercent(value) {
        if (value === null || value === undefined) {
          return "-";
        }
        return (value * 100).toFixed(2) + "%";
      }

      // è·å–ç™¾åˆ†æ¯”æ ·å¼ç±»
      function getPercentClass(value) {
        if (value === null || value === undefined) return "";
        if (value >= 0.5) return "percent-high";
        return "percent-low";
      }

      // æ ¼å¼åŒ–å¸ƒå°”å€¼
      function formatBoolean(value) {
        if (value === null || value === undefined) {
          return "-";
        }
        return value ? "100%" : "0%";
      }

      // è·å–å¸ƒå°”å€¼æ ·å¼ç±»
      function getBooleanClass(value) {
        if (value === null || value === undefined) return "";
        return value ? "boolean-true" : "boolean-false";
      }

      // è·å–M5ä¿¡å·æ ·å¼ç±»
      function getSignalClass(signal) {
        if (!signal) return "";
        return signal === "å¤š" ? "signal-high" : "signal-low";
      }

      // æ ¼å¼åŒ–æ—¶é—´ï¼ˆæˆªå–å‰19ä¸ªå­—ç¬¦ï¼‰
      function formatTime(timeStr) {
        if (!timeStr) return "-";
        return timeStr.substring(0, 19);
      }

      // æ’åºæ•°æ®
      function sortData(data, column, direction, dataType) {
        return [...data].sort((a, b) => {
          let aVal = a[column];
          let bVal = b[column];

          // å¤„ç† null/undefined
          if (aVal === null || aVal === undefined) aVal = dataType === 'number' || dataType === 'percent' ? -Infinity : '';
          if (bVal === null || bVal === undefined) bVal = dataType === 'number' || dataType === 'percent' ? -Infinity : '';

          // æ ¹æ®æ•°æ®ç±»å‹æ¯”è¾ƒ
          let comparison = 0;
          if (dataType === 'number' || dataType === 'percent') {
            comparison = aVal - bVal;
          } else if (dataType === 'boolean') {
            comparison = (aVal === bVal) ? 0 : aVal ? 1 : -1;
          } else {
            comparison = String(aVal).localeCompare(String(bVal));
          }

          return direction === 'asc' ? comparison : -comparison;
        });
      }

      // é»˜è®¤æ’åºï¼šæŒ‰é¢„å®šä¹‰åç§°åˆ—è¡¨æ’åº
      function applyDefaultSort(data) {
        // é¢„å®šä¹‰çš„æ’åºåˆ—è¡¨
        const sortOrder = [
          'ç§‘åˆ›50ETF', 'äººå·¥æ™ºèƒ½AIETF', 'äº‘è®¡ç®—50ETF', '5Gé€šä¿¡ETF', 'åŠå¯¼ä½“ETF', 'èŠ¯ç‰‡ETF',
          'æ¸¸æˆETF', 'å½±è§†ETF', 'ä¼ åª’ETF', 'æœºå™¨äººETF', 'åšç¿æ•°æ®', 'æ¶¦å’Œè½¯ä»¶', 'æ˜†ä»‘ä¸‡ç»´',
          'å·¨äººç½‘ç»œ', 'ä¸‰ä¸ƒäº’å¨±', 'ç¥å·æ³°å²³', 'æµ·åº·å¨è§†', 'æµ™æ–‡äº’è”', 'ä¸­é™…æ—­åˆ›', 'æ–°æ˜“ç››',
          'ä¸­ç§‘æ›™å…‰', 'æ¾œèµ·ç§‘æŠ€', 'é‡‘å±±åŠå…¬', 'å¯’æ­¦çºª-U', 'ç´«å…‰è‚¡ä»½', 'ç§‘å¤§è®¯é£', 'æ±‡å·æŠ€æœ¯',
          'æœºå™¨äºº', 'å¤§åè‚¡ä»½', 'ä¸­æ§æŠ€æœ¯', 'çŸ³å¤´ç§‘æŠ€', 'åŒ—æ–¹ååˆ›', 'ä¸­èŠ¯å›½é™…', 'æ·±åœ³åå¼º',
          'ä¸­å¾®å…¬å¸', 'æµ·å…‰ä¿¡æ¯', 'è±ªå¨é›†å›¢', 'ç«‹è®¯ç²¾å¯†', 'ä¸­å…´é€šè®¯', 'å·¥ä¸šå¯Œè”', 'æ·æˆè‚¡ä»½',
          'å…‰çº¿ä¼ åª’', 'èŠ’æœè¶…åª’', 'ä¸œæ–¹æ˜ç ', 'å®Œç¾ä¸–ç•Œ', 'ä¸‡è¾¾ç”µå½±', 'åˆ†ä¼—ä¼ åª’', 'åˆ©æ¬§è‚¡ä»½',
          'æºè‹±ç½‘ç»œ', 'è“è‰²å…‰æ ‡', 'é«˜æ–°å‘å±•', 'æ¯æ—¥äº’åŠ¨', 'ç”µæ± ETF', 'å…‰ä¼ETF', 'æ–°èƒ½æºè½¦ETF',
          'ç¢³ä¸­å’ŒETF', 'å¤©é½é”‚ä¸š', 'äº¿çº¬é”‚èƒ½', 'èµ£é”‹é”‚ä¸š', 'å®å¾·æ—¶ä»£', 'æ¯”äºšè¿ª', 'å®å‘è‚¡ä»½',
          'æ³•æ‹‰ç”µå­', 'å¤©èµææ–™', 'ä¸­çŸ¿èµ„æº', 'å›½è½©é«˜ç§‘', 'é˜³å…‰ç”µæº', 'éš†åŸºç»¿èƒ½', 'TCLç§‘æŠ€',
          'ç‰¹å˜ç”µå·¥', 'é€šå¨è‚¡ä»½', 'æ™¶ç§‘èƒ½æº', 'æ­£æ³°ç”µå™¨', 'é•¿æ±Ÿç”µåŠ›', 'ä¸­å›½æ ¸ç”µ', 'å›½æŠ•ç”µåŠ›',
          'çˆ±æ—­è‚¡ä»½', 'é‡‘é£ç§‘æŠ€', 'é”¦æµªç§‘æŠ€', 'ä¸‰èŠ±æ™ºæ§', 'åå‹é’´ä¸š', 'æ ¼æ—ç¾', 'ä¸­æ¦‚äº’è”ç½‘ETF',
          'æ’ç”Ÿç§‘æŠ€ETF', 'æ’ç”Ÿäº’è”ç½‘ETF', 'æ’ç”ŸETF', 'é…’ETF', 'è´µå·èŒ…å°', 'äº” ç²® æ¶²',
          'æ³¸å·è€çª–', 'åŒ»ç–—ETF', 'ä¸­è¯ETF', 'è¯æ˜åº·å¾·', 'æ’ç‘åŒ»è¯', 'åˆ¸å•†ETF', 'ç¨€åœŸETF',
          'é“¶è¡ŒETF', 'ç…¤ç‚­ETF', 'åˆ›ä¸šæ¿ETF', 'ä¸Šè¯50ETF', 'æ²ªæ·±300ETF', 'ä¸­è¯500ETF'
        ];

        // åˆ›å»ºåç§°åˆ°ç´¢å¼•çš„æ˜ å°„
        const orderMap = new Map();
        sortOrder.forEach((name, index) => {
          orderMap.set(name, index);
        });

        return [...data].sort((a, b) => {
          const aName = a.etfName || a.stockName || '';
          const bName = b.etfName || b.stockName || '';

          const aIndex = orderMap.has(aName) ? orderMap.get(aName) : Number.MAX_SAFE_INTEGER;
          const bIndex = orderMap.has(bName) ? orderMap.get(bName) : Number.MAX_SAFE_INTEGER;

          // å¦‚æœä¸¤ä¸ªéƒ½åœ¨åˆ—è¡¨ä¸­ï¼ŒæŒ‰åˆ—è¡¨é¡ºåºæ’åº
          if (aIndex !== bIndex) {
            return aIndex - bIndex;
          }

          // å¦‚æœéƒ½ä¸åœ¨åˆ—è¡¨ä¸­ï¼ŒæŒ‰åç§°å­—æ¯é¡ºåºæ’åº
          return aName.localeCompare(bName, 'zh-CN');
        });
      }

      // æ£€æŸ¥æ•°æ®å˜æ›´ç±»å‹
      function getDataChangeType(code, newData) {
        const oldData = previousData.find((d) => d.etfCode === code);

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œä¸æ˜¾ç¤ºåŠ¨ç”»
        if (isFirstLoad) return null;

        // æ–°æ•°æ®
        if (!oldData) return 'new';

        // æ’é™¤ç”¨æˆ·è¦æ±‚ç§»é™¤çš„å­—æ®µï¼Œç¡®ä¿æ¯”è¾ƒé€»è¾‘ä¿æŒç®€æ´
        const strippedNewData = { ...newData };
        delete strippedNewData.holdStatus;
        delete strippedNewData.greaterThanM0Price;

        const strippedOldData = { ...oldData };
        delete strippedOldData.holdStatus;
        delete strippedOldData.greaterThanM0Price;

        // æ•°æ®æœ‰æ›´æ–°
        if (JSON.stringify(strippedOldData) !== JSON.stringify(strippedNewData)) {
          return 'updated';
        }

        return null;
      }

      // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨
      function updateSortIndicators() {
        document.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
          if (th.dataset.column === sortColumn) {
            th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
          }
        });
      }

      // å¤„ç†åˆ—ç‚¹å‡»æ’åº
      function handleColumnClick(column, dataType) {
        if (sortColumn === column) {
          // åŒä¸€åˆ—ï¼šåˆ‡æ¢æ’åºæ–¹å‘
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          // æ–°åˆ—ï¼šé»˜è®¤å‡åº
          sortColumn = column;
          sortDirection = 'asc';
        }

        updateSortIndicators();

        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderTable(previousData);
      }



      // å­˜å‚¨ä¸Šä¸€æ¬¡çš„ç»Ÿè®¡æ•°æ®ç”¨äºå¯¹æ¯”
      let previousStats = null;

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      function updateStats(data) {
        const statsGrid = document.getElementById("statsGrid");

        // è¿‡æ»¤å‡ºä¸ä¸ºç©ºçš„æ•°æ®
        const m5Data = data.filter((d) => d.m5Percent !== null && d.m5Percent !== undefined);
        const m10Data = data.filter((d) => d.m10Percent !== null && d.m10Percent !== undefined);
        const m20Data = data.filter((d) => d.m20Percent !== null && d.m20Percent !== undefined);

        // è®¡ç®—å„é¡¹å‡å€¼
        const avgM5Percent = m5Data.length > 0
            ? ((m5Data.reduce((sum, d) => sum + d.m5Percent, 0) / m5Data.length) * 100).toFixed(2)
            : 0;

        const avgM10Percent = m10Data.length > 0
            ? ((m10Data.reduce((sum, d) => sum + d.m10Percent, 0) / m10Data.length) * 100).toFixed(2)
            : 0;

        const avgM20Percent = m20Data.length > 0
            ? ((m20Data.reduce((sum, d) => sum + d.m20Percent, 0) / m20Data.length) * 100).toFixed(2)
            : 0;

        // Maå‡å€¼å æ¯” = (M5å æ¯” + M10å æ¯” + M20å æ¯”) / 3
        const maAvg = ((parseFloat(avgM5Percent) + parseFloat(avgM10Percent) + parseFloat(avgM20Percent)) / 3).toFixed(2);

        // M5ä¿¡å· (M5å æ¯”å¤§äº50%æ˜¾ç¤ºå¤š,å¦åˆ™æ˜¾ç¤ºç©º)
        const m5Signal = parseFloat(avgM5Percent) > 50 ? "å¤š" : "ç©º";
        const m5SignalClass = getSignalClass(m5Signal);

        // å¢é•¿è‚¡æ•°å’Œæ€»è‚¡æ•°
        const growthStockSum = data.reduce((sum, d) => sum + (d.growthStockCount || 0), 0);
        const totalStockSum = data.reduce((sum, d) => sum + (d.totalStockCount || 0), 0);

        // å½“å‰ç»Ÿè®¡æ•°æ®
        const currentStats = {
          m5Signal,
          avgM5Percent,
          avgM10Percent,
          avgM20Percent,
          maAvg,
          growthStockSum,
          totalStockSum
        };

        // æ£€æŸ¥å“ªäº›ç»Ÿè®¡é¡¹å‘ç”Ÿäº†å˜åŒ–
        const changedStats = new Set();
        if (previousStats && !isFirstLoad) {
          if (previousStats.m5Signal !== currentStats.m5Signal) changedStats.add('m5Signal');
          if (previousStats.avgM5Percent !== currentStats.avgM5Percent) changedStats.add('avgM5Percent');
          if (previousStats.avgM10Percent !== currentStats.avgM10Percent) changedStats.add('avgM10Percent');
          if (previousStats.avgM20Percent !== currentStats.avgM20Percent) changedStats.add('avgM20Percent');
          if (previousStats.maAvg !== currentStats.maAvg) changedStats.add('maAvg');
          if (previousStats.growthStockSum !== currentStats.growthStockSum) changedStats.add('growthStockSum');
          if (previousStats.totalStockSum !== currentStats.totalStockSum) changedStats.add('totalStockSum');
        }

        statsGrid.innerHTML = `
                <div class="stat-card ${changedStats.has('m5Signal') ? 'highlight-stat' : ''}">
                    <div class="stat-label">M5ä¿¡å·</div>
                    <div class="stat-value"><span style="padding: 3px 10px;border-radius: 8px;" class="${m5SignalClass}">${m5Signal}</span></div>
                </div>
                <div class="stat-card ${changedStats.has('avgM5Percent') ? 'highlight-stat' : ''}">
                    <div class="stat-label">M5å æ¯”</div>
                    <div class="stat-value">${avgM5Percent}%</div>
                </div>
                <div class="stat-card ${changedStats.has('avgM10Percent') ? 'highlight-stat' : ''}">
                    <div class="stat-label">M10å æ¯”</div>
                    <div class="stat-value">${avgM10Percent}%</div>
                </div>
                <div class="stat-card ${changedStats.has('avgM20Percent') ? 'highlight-stat' : ''}">
                    <div class="stat-label">M20å æ¯”</div>
                    <div class="stat-value">${avgM20Percent}%</div>
                </div>
                <div class="stat-card ${changedStats.has('maAvg') ? 'highlight-stat' : ''}">
                    <div class="stat-label">Maå‡å€¼å æ¯”</div>
                    <div class="stat-value">${maAvg}%</div>
                </div>
                <div class="stat-card ${changedStats.has('growthStockSum') ? 'highlight-stat' : ''}">
                    <div class="stat-label">å¢é•¿è‚¡æ•°</div>
                    <div class="stat-value">${growthStockSum}</div>
                </div>
                <div class="stat-card ${changedStats.has('totalStockSum') ? 'highlight-stat' : ''}">
                    <div class="stat-label">æ€»è‚¡æ•°</div>
                    <div class="stat-value">${totalStockSum}</div>
                </div>
            `;

        // ä¿å­˜å½“å‰ç»Ÿè®¡æ•°æ®ä¾›ä¸‹æ¬¡å¯¹æ¯”
        previousStats = currentStats;
      }

      // æ¸²æŸ“è¡¨æ ¼
      function renderTable(data) {
        const tableBody = document.getElementById("tableBody");
        const loadingDiv = document.getElementById("loadingDiv");
        const errorDiv = document.getElementById("errorDiv");
        const table = document.getElementById("dataTable");
        const noDataDiv = document.getElementById("noDataDiv");

        // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
        const tableContainer = document.querySelector('.table-container');
        const scrollTop = tableContainer ? tableContainer.scrollTop : 0;

        loadingDiv.style.display = "none";
        errorDiv.style.display = "none";

        if (!data || data.length === 0) {
          table.style.display = "none";
          noDataDiv.style.display = "block";
          return;
        }

        table.style.display = "table";
        noDataDiv.style.display = "none";

        // åº”ç”¨æ’åº
        let sortedData;
        if (sortColumn) {
          // ç”¨æˆ·æŒ‡å®šäº†æ’åºåˆ—
          const th = document.querySelector(`th[data-column="${sortColumn}"]`);
          const dataType = th ? th.dataset.type : 'string';
          sortedData = sortData(data, sortColumn, sortDirection, dataType);
        } else {
          // ä½¿ç”¨é»˜è®¤æ’åº
          sortedData = applyDefaultSort(data);
        }

        tableBody.innerHTML = sortedData
          .map((item) => {
            const changeType = getDataChangeType(item.etfCode, item);
            const rowClass = changeType ? `highlight-${changeType}` : "";

            // è·å–æ€»åˆ†æ•°èƒŒæ™¯è‰²ç±»
            const getScoreClass = (score) => {
              if (score === null || score === undefined) return "";
              return score > 3 ? "score-high" : "score-low";
            };

            return `
                    <tr class="${rowClass}">
                        <td class="time-cell">${formatTime(
                          item.updateTime
                        )}</td>
                        <td class="code-cell">${item.etfCode || "-"}</td>
                        <td>${item.etfName || "-"}</td>
                        <td class="${getScoreClass(item.totalScore)}">${item.totalScore || "0"}</td>
                        <td class="${getSignalClass(item.m5Signal)}">${item.m5Signal || "-"}</td>
                        <td class="${getBooleanClass(
                          item.greaterThanM5Price
                        )}">${formatBoolean(item.greaterThanM5Price)}</td>
                        <td class="${getBooleanClass(
                          item.greaterThanM10Price
                        )}">${formatBoolean(item.greaterThanM10Price)}</td>
                        <td class="${getBooleanClass(
                          item.greaterThanM20Price
                        )}">${formatBoolean(item.greaterThanM20Price)}</td>
                        <td class="percent-value ${getPercentClass(
                          item.m0Percent
                        )}">${formatPercent(item.m0Percent)}</td>
                        <td class="percent-value ${getPercentClass(
                          item.m5Percent
                        )}">${formatPercent(item.m5Percent)}</td>
                        <td class="percent-value ${getPercentClass(
                          item.m10Percent
                        )}">${formatPercent(item.m10Percent)}</td>
                        <td class="percent-value ${getPercentClass(
                          item.m20Percent
                        )}">${formatPercent(item.m20Percent)}</td>
                        <td class="percent-value ${getPercentClass(
                          item.maMeanRatio
                        )}">${formatPercent(item.maMeanRatio)}</td>
                        <td>${item.growthStockCount || "-"}</td>
                        <td>${item.totalStockCount || "-"}</td>
                    </tr>
                `;
          })
          .join("");

        // æ¢å¤æ»šåŠ¨ä½ç½®
        if (scrollTop > 0 && tableContainer) {
          // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ›´æ–°
          requestAnimationFrame(() => {
            tableContainer.scrollTop = scrollTop;
          });
        }

        // æ³¨æ„: ä¸åœ¨è¿™é‡Œæ›´æ–° previousData,ç”± fetchData ç»Ÿä¸€ç®¡ç†æ•°æ®æ›´æ–°
      }

      // è·å–æ•°æ®
      async function fetchData() {
        try {
          // æ„å»ºè¯·æ±‚URL,æ”¯æŒå¢é‡æŸ¥è¯¢
          let url = "/allDataList";
          if (!isFirstLoad && lastUpdateTime) {
            url += `?since=${encodeURIComponent(lastUpdateTime)}`;
          }

          // å‘èµ·è¯·æ±‚
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
          }

          const newData = await response.json();

          // å‡†å¤‡æ›´æ–°çš„æ•°æ®(å…ˆä¸ä¿®æ”¹previousData)
          let updatedData;

          if (!isFirstLoad && lastUpdateTime && newData.length > 0) {
            // å¢é‡æ›´æ–°: åˆ›å»ºpreviousDataçš„å‰¯æœ¬å¹¶åˆå¹¶æ–°æ•°æ®
            updatedData = JSON.parse(JSON.stringify(previousData));
            mergeIncrementalDataToTarget(updatedData, newData);
          } else if (isFirstLoad || !lastUpdateTime) {
            // å…¨é‡æ›´æ–°
            updatedData = JSON.parse(JSON.stringify(newData));
            isFirstLoad = false;
          } else {
            // å¢é‡æŸ¥è¯¢ä½†æ— æ–°æ•°æ®,ä¿æŒåŸæ•°æ®
            updatedData = previousData;
          }

          // æ•°æ®éªŒè¯æˆåŠŸå,æ‰æ›´æ–°previousData
          previousData = updatedData;

          // æ›´æ–°UI
          updateUIWithData(updatedData);

          // æ›´æ–°ç½‘ç»œçŠ¶æ€ä¸ºåœ¨çº¿
          updateNetworkStatus('online');

        } catch (error) {
          console.error("è·å–æ•°æ®å¤±è´¥:", error);
          updateNetworkStatus('offline');

          // ç½‘ç»œå¼‚å¸¸æ—¶,ä¿ç•™æ—§æ•°æ®ç»§ç»­æ˜¾ç¤º,ä¸éšè—è¡¨æ ¼
          // åªæœ‰åœ¨æ²¡æœ‰ä»»ä½•æ•°æ®æ—¶æ‰æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          if (!previousData || previousData.length === 0) {
            const errorDiv = document.getElementById("errorDiv");
            errorDiv.textContent = `è·å–æ•°æ®å¤±è´¥: ${error.message}`;
            errorDiv.style.display = "block";
            document.getElementById("loadingDiv").style.display = "none";
            document.getElementById("dataTable").style.display = "none";
          }
          // å¦‚æœæœ‰æ—§æ•°æ®,ä»€ä¹ˆéƒ½ä¸åš,ç»§ç»­æ˜¾ç¤ºæ—§æ•°æ®
        }
      }

      // åˆå¹¶å¢é‡æ•°æ®åˆ°ç›®æ ‡æ•°ç»„(ä¸ç›´æ¥ä¿®æ”¹previousData)
      function mergeIncrementalDataToTarget(targetData, incrementalData) {
        incrementalData.forEach(newItem => {
          const existingIndex = targetData.findIndex(item => item.etfCode === newItem.etfCode);
          if (existingIndex >= 0) {
            // æ›´æ–°ç°æœ‰æ•°æ®
            targetData[existingIndex] = newItem;
          } else {
            // æ·»åŠ æ–°æ•°æ®
            targetData.push(newItem);
          }
        });
        return targetData;
      }

      // ç»Ÿä¸€çš„UIæ›´æ–°é€»è¾‘
      function updateUIWithData(data) {
        // è·å–æ•°æ®ä¸­çš„æœ€å¤§æ—¶é—´(åªæœ‰åœ¨æœ‰æ•°æ®æ—¶æ‰æ›´æ–°)
        if (data.length > 0) {
          const maxTime = data.reduce((max, item) => {
            return item.updateTime > max ? item.updateTime : max;
          }, "1970-01-01 00:00:00");

          // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´æ˜¾ç¤º(æˆªå–å‰19ä¸ªå­—ç¬¦)
          document.getElementById("lastUpdate").textContent = `æœ€åæ›´æ–°: ${maxTime.substring(0, 19)}`;

          // æ›´æ–° lastUpdateTime ä¸ºæ•°æ®ä¸­çš„æœ€å¤§æ—¶é—´,ç”¨äºä¸‹æ¬¡å¢é‡æŸ¥è¯¢
          lastUpdateTime = maxTime.substring(0, 19);
        }

        // æ›´æ–°æ•°æ®è®¡æ•°
        document.getElementById("dataCount").textContent = data.length;

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStats(data);

        // æ¸²æŸ“è¡¨æ ¼
        renderTable(data);
      }

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        // æ·»åŠ è¡¨å¤´ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', () => {
            const column = th.dataset.column;
            const dataType = th.dataset.type;
            handleColumnClick(column, dataType);
          });
        });

        // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®ï¼ˆå…¨é‡ï¼‰
        fetchData();

        // æ¯3ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆå¢é‡ï¼‰
        setInterval(fetchData, 10000);

        // æ¯30ç§’å¼ºåˆ¶å…¨é‡åˆ·æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
        // setInterval(() => {
        //   isFirstLoad = true;
        //   lastUpdateTime = null;
        //   fetchData();
        // }, 30000);
      });
    </script>
  </body>
</html>
